
# 类文件结构

## JVM 的“无关性”
- 平台无关性：任何操作系统都能运行 Java 代码
- 语言无关性： JVM 能运行除 Java 以外的其他代码

Java 源代码首先需要使用 Javac 编译器编译成 .class 文件，然后由 JVM 执行 .class 文件，从而程序开始运行。

JVM 只认识 .class 文件，它不关心是何种语言生成了 .class 文件，只要 .class 文件符合 JVM 的规范就能运行。
目前已经有 JRuby、Jython、Scala 等语言能够在 JVM 上运行。它们有各自的语法规则，不过它们的编译器
都能将各自的源码编译成符合 JVM 规范的 .class 文件，从而能够借助 JVM 运行它们。

> Java 语言中的各种变量、关键字和运算符号的语义最终都是由多条字节码命令组合而成的，
因此字节码命令所能提供的语义描述能力肯定会比 Java 语言本身更加强大。
因此，有一些 Java 语言本身无法有效支持的语言特性，不代表字节码本身无法有效支持。

## Class 文件结构
Class 文件时二进制文件，它的内容具有严格的规范，文件中没有任何空格，全都是连续的 0/1。Class 文件
中的所有内容被分为两种类型：无符号数、表。

- 无符号数<br>
无符号数表示 Class 文件中的值，这些值没有任何类型，但有不同的长度。u1、u2、u4、u8 分别代表 1/2/4/8 字节的无符号数。

- 表<br>
由多个无符号数或者其他表作为数据项构成的符合数据类型。

Class 文件具体由以下几个构成:

- 魔数
- 版本信息
- 常量池
- 访问标志
- 类索引、父类索引、接口索引集合
- 字段表集合
- 方法表集合

### 魔数
Class 文件的头 4 个字节称为魔数，用来表示这个 Class 文件的类型。

Class 文件的魔数是用 16 进制表示的“CAFE BABE”，是不是很具有浪漫色彩？

> 魔数相当于文件后缀名，只不过后缀名容易被修改，不安全，因此在 Class 文件中标识文件类型比较合适。

### 版本信息
紧接着魔数的 4 个字节是版本信息，5~6 字节表示次版本号，7~8 字节表示主版本号，它们表示当前 Class 文件中使用的是哪个版本的 JDK。

高版本的 JDK 能向下兼容以前版本的 Class 文件，但不能运行以后版本的 Class 文件，即时文件格式并未发生任何变化，虚拟机也必需拒绝执行超过其版本号的 Class 文件。

### 常量池
版本信息之后就是常量池，常量池中存放两种类型的常量：<br>
- 字面值常量<br>
字面值常量就是我们在程序中定义的字符串、被 final 修饰的值。
- 符号引用<br>
符号引用就是我们定义的各种名字：类和接口的全限定名、字段的名字和描述符、方法的名字和描述符。

#### 常量池的特点
- 常量池中常量数量不固定，因此常量池开头放置一个 u2 类型的无符号数，用来存储当前常量池的容量。
- 常量池的每一项常量都是一个表，表开始的第一位是一个 u1 类型的标志位(tag)，代表当前这个常量属于哪种常量类型。

#### 常量池中常量类型
| 类型    | tag   | 描述　|
|---|---|---|
| CONSTANT_utf8_info | 1 | UTF-8编码的字符串 |
CONSTANT_Integer_info | 3   | 整型字面量
CONSTANT_Float_info | 4 | 浮点型字面量
CONSTANT_Long_info  |5 | 长整型字面量
CONSTANT_Double_info | 6 |  双精度浮点型字面量
CONSTANT_Class_info | 7 |   类或接口的符号引用
CONSTANT_String_info    | 8 |   字符串类型字面量
CONSTANT_Fieldref_info  | 9 |   字段的符号引用
CONSTANT_Methodref_info | 10 |  类中方法的符号引用
CONSTANT_InterfaceMethodref_info    | 11 |  接口中方法的符号引用
CONSTANT_NameAndType_info | 12 |    字段或方法的符号引用
CONSTANT_MethodHandle_info  | 15 |  表示方法句柄
CONSTANT_MethodType_info    | 16 |  标识方法类型
CONSTANT_InvokeDynamic_info | 18 |  表示一个动态方法调用点

对于 CONSTANT_Class_info（此类型的常量代表一个类或者接口的符号引用），它的二维表结构如下：

| 类型 | 名称 | 数量 |
|---|---|---|
| u1 | tag | 1 |
| u2 | name_index | 1 |

tag 是标志位，用于区分常量类型；name_index 是一个索引值，它指向常量池中一个 CONSTANT_Utf8_info 类型常量，此常量代表这个类（或接口）的全限定名，这里 name_index 值若为 0x0002，也即是指向了常量池中的第二项常量。

CONSTANT_Utf8_info 型常量的结构如下：

| 类型 | 名称 | 数量 |
|---|---|---|
| u1 | tag | 1 |
| u2 | length | 1 |
| u1 | bytes | length |

